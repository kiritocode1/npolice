import { getSearchData } from "@/data/searchData";
import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";

// Initialize OpenAI client (server-side only)
const openai = new OpenAI({
	apiKey: process.env.OPENAI_API_KEY, // Server-side env var
});

// Cache for embeddings with 1-hour expiry
interface CachedEmbedding {
	embedding: number[];
	timestamp: number;
}

interface CachedSimilarity {
	similarities: number[];
	timestamp: number;
}

const embeddingCache = new Map<string, CachedEmbedding>();
const similarityCache = new Map<string, CachedSimilarity>();
const CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

// Global variables for caching
let documentEmbeddings: number[][] = [];
let documents: any[] = [];

// Generate embedding using OpenAI
async function generateEmbedding(text: string): Promise<number[]> {
	// Check cache first
	const cacheKey = text.toLowerCase().trim();
	const cached = embeddingCache.get(cacheKey);

	if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
		return cached.embedding;
	}

	try {
		const response = await openai.embeddings.create({
			model: "text-embedding-ada-002",
			input: text,
		});

		const embedding = response.data[0].embedding;

		// Cache the result
		embeddingCache.set(cacheKey, {
			embedding,
			timestamp: Date.now(),
		});

		return embedding;
	} catch (error) {
		console.error("OpenAI embedding generation failed:", error);
		throw error;
	}
}

// Cosine similarity function
function cosineSimilarity(a: number[], b: number[]): number {
	if (a.length !== b.length) return 0;

	let dotProduct = 0;
	let normA = 0;
	let normB = 0;

	for (let i = 0; i < a.length; i++) {
		dotProduct += a[i] * b[i];
		normA += a[i] * a[i];
		normB += b[i] * b[i];
	}

	if (normA === 0 || normB === 0) return 0;

	return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
}

// Initialize embeddings
async function initializeEmbeddings(searchData: any[]): Promise<void> {
	if (documentEmbeddings.length === searchData.length && documents.length === searchData.length) {
		return; // Already initialized
	}

	try {
		documents = searchData;
		const documentTexts = documents.map((doc) => `${doc.title} ${doc.description} ${doc.category} ${doc.keywords.join(" ")}`);

		// Generate embeddings for all documents
		documentEmbeddings = await Promise.all(documentTexts.map((text) => generateEmbedding(text)));

		console.log("üîç Server: Embeddings initialized", {
			documentCount: documents.length,
			embeddingCount: documentEmbeddings.length,
		});
	} catch (error) {
		console.error("Failed to initialize embeddings:", error);
		throw error;
	}
}

export async function POST(request: NextRequest) {
	try {
		const { query, language = "en" } = await request.json();

		if (!query || typeof query !== "string") {
			return NextResponse.json({ error: "Query is required" }, { status: 400 });
		}

		// Create a proper translation function based on language
		const translations = {
			en: {
				"nav.home.simple": "Home",
				"nav.about.us": "About Us",
				"nav.about.senior": "Senior Officer Profile",
				"nav.about.organization": "Organizational Structure",
				"nav.about.jurisdiction": "Jurisdiction Map",
				"nav.about.initiatives": "Initiatives",
				"nav.about.gallery": "Photo Gallery",
				"nav.about.history": "History of Nashik Police",
				"nav.about.stations": "Police Station Incharge",
				"nav.about.contact": "Contact Us",
				"nav.about.feedback": "Feedback",
				"nav.special.crime.unit1": "Crime Branch Unit 1",
				"nav.special.crime.unit2": "Crime Branch Unit 2",
				"nav.special.crime.pcb": "Central Crime Unit (PCB)",
				"nav.special.crime.antiGunda": "Anti-Gunda Squad",
				"nav.special.crime.antiNarcotic": "Anti-Narcotic Cell",
				"nav.special.crime.antiExtortion": "Anti-Extortion Cell",
				"nav.special.crime.technical": "Technical Analysis",
				"nav.special.crime.wing": "Technical Analysis Wing",
				"nav.special.crime.women": "Women Safety Cell",
				"nav.special.crime.economic": "Economic Offence Wing",
				"nav.special.control": "Control Room",
				"nav.special.headquarters": "Police Headquarters",
				"nav.special.bomb": "Bomb Detection and Disposal Squad",
				"nav.special.transport": "Motor Transport Organization",
				"nav.citizen.cyberTips": "Cyber Security Tips",
				"nav.citizen.cyberAwareness": "Cyber Awareness",
				"nav.citizen.recruitment": "Police Recruitment",
				"nav.citizen.pressRelease": "Press Release",
				"nav.citizen.rti": "Right to Information",
				"nav.citizen.publicService": "Maharashtra Public Service Rights Act",
				"nav.citizen.passport": "Passport Status",
				"nav.citizen.websites": "Useful Websites",
				"nav.citizen.wall": "Citizen Wall",
				"nav.citizen.tenders": "Tenders",
				"nav.police.circular": "Circular / Notification",
				"nav.police.welfare": "Welfare Initiatives",
				"nav.police.media": "Media Coverage",
				"nav.police.crimeReview": "Crime Review",
				"nav.police.goodWork": "Good Work",
			},
			mr: {
				"nav.home.simple": "‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§™‡•É‡§∑‡•ç‡§†",
				"nav.about.us": "‡§Ü‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§∑‡§Ø‡•Ä",
				"nav.about.senior": "‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤",
				"nav.about.organization": "‡§∏‡§Ç‡§ò‡§ü‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§∞‡§ö‡§®‡§æ",
				"nav.about.jurisdiction": "‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§®‡§ï‡§æ‡§∂‡§æ",
				"nav.about.initiatives": "‡§â‡§™‡§ï‡•ç‡§∞‡§Æ",
				"nav.about.gallery": "‡§õ‡§æ‡§Ø‡§æ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π",
				"nav.about.history": "‡§®‡§æ‡§∂‡§ø‡§ï ‡§™‡•ã‡§≤‡•Ä‡§∏‡§æ‡§Ç‡§ö‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏",
				"nav.about.stations": "‡§™‡•ã‡§≤‡•Ä‡§∏ ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§™‡•ç‡§∞‡§≠‡§æ‡§∞‡•Ä",
				"nav.about.contact": "‡§Ü‡§Æ‡§ö‡•ç‡§Ø‡§æ‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§æ",
				"nav.about.feedback": "‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø",
				"nav.special.crime.unit1": "‡§ó‡•Å‡§®‡•ç‡§π‡•á ‡§∂‡§æ‡§ñ‡§æ ‡§µ‡§ø‡§µ‡§ø‡§ß ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï ‡•ß",
				"nav.special.crime.unit2": "‡§ó‡•Å‡§®‡•ç‡§π‡•á ‡§∂‡§æ‡§ñ‡§æ ‡§µ‡§ø‡§µ‡§ø‡§ß ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï ‡•®",
				"nav.special.crime.pcb": "‡§Æ‡§ß‡•ç‡§Ø‡§µ‡§∞‡•ç‡§§‡•Ä ‡§ó‡•Å‡§®‡•ç‡§π‡•á ‡§∂‡§æ‡§ñ‡§æ",
				"nav.special.crime.antiGunda": "‡§ó‡•Å‡§Ç‡§°‡§æ‡§µ‡§ø‡§∞‡•ã‡§ß‡•Ä ‡§™‡§•‡§ï",
				"nav.special.crime.antiNarcotic": "‡§Ö‡§Ç‡§Æ‡§≤‡•Ä ‡§™‡§¶‡§æ‡§∞‡•ç‡§• ‡§µ‡§ø‡§∞‡•ã‡§ß‡•Ä ‡§∏‡•á‡§≤",
				"nav.special.crime.antiExtortion": "‡§ñ‡§Ç‡§°‡§£‡•Ä ‡§µ‡§ø‡§∞‡•ã‡§ß‡•Ä ‡§™‡§•‡§ï",
				"nav.special.crime.technical": "‡§§‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£",
				"nav.special.crime.wing": "‡§§‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§µ‡§ø‡§Ç‡§ó",
				"nav.special.crime.women": "‡§Æ‡§π‡§ø‡§≤‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡§ï‡•ç‡§∑",
				"nav.special.crime.economic": "‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§ó‡•Å‡§®‡•ç‡§π‡•á ‡§∂‡§æ‡§ñ‡§æ",
				"nav.special.control": "‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§ï‡§ï‡•ç‡§∑",
				"nav.special.headquarters": "‡§™‡•ã‡§≤‡•Ä‡§∏ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§≤‡§Ø",
				"nav.special.bomb": "‡§¨‡§æ‡§Å‡§¨ ‡§∂‡•ã‡§ß‡§ï ‡§µ ‡§®‡§æ‡§∂‡§ï ‡§™‡§•‡§ï",
				"nav.special.transport": "‡§Æ‡•ã‡§ü‡§∞ ‡§µ‡§æ‡§π‡§® ‡§µ‡§ø‡§≠‡§æ‡§ó",
				"nav.citizen.cyberTips": "‡§∏‡§æ‡§Ø‡§¨‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ü‡§ø‡§™‡•ç‡§∏",
				"nav.citizen.cyberAwareness": "‡§∏‡§æ‡§Ø‡§¨‡§∞ ‡§ú‡§®‡§ú‡§æ‡§ó‡•É‡§§‡•Ä",
				"nav.citizen.recruitment": "‡§™‡•ã‡§≤‡•Ä‡§∏ ‡§≠‡§∞‡§§‡•Ä",
				"nav.citizen.pressRelease": "‡§™‡•ç‡§∞‡•á‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§®",
				"nav.citizen.rti": "‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä‡§ö‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞",
				"nav.citizen.publicService": "‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§≤‡•ã‡§ï‡§∏‡•á‡§µ‡§æ ‡§π‡§ï‡•ç‡§ï ‡§Ö‡§ß‡§ø‡§®‡§ø‡§Ø‡§Æ",
				"nav.citizen.passport": "‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä",
				"nav.citizen.websites": "‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü",
				"nav.citizen.wall": "‡§∏‡§ø‡§ü‡•Ä‡§ù‡§® ‡§µ‡•â‡§≤",
				"nav.citizen.tenders": "‡§®‡§ø‡§µ‡§ø‡§¶‡§æ",
				"nav.police.circular": "‡§™‡§∞‡§ø‡§™‡§§‡•ç‡§∞‡§ï / ‡§Ö‡§ß‡§ø‡§∏‡•Ç‡§ö‡§®‡§æ",
				"nav.police.welfare": "‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§ï‡•ç‡§∞‡§Æ",
				"nav.police.media": "‡§µ‡•É‡§§‡•ç‡§§‡§æ‡§Ç‡§ï‡§®",
				"nav.police.crimeReview": "‡§ó‡•Å‡§®‡•ç‡§π‡•á ‡§Ü‡§¢‡§æ‡§µ‡§æ",
				"nav.police.goodWork": "‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡§ï‡§æ‡§Æ‡§ó‡§ø‡§∞‡•Ä",
			},
		};

		const t = (key: string) => translations[language as keyof typeof translations][key as keyof (typeof translations)[keyof typeof translations]] || key;

		// Get search data and strip React components for serialization
		const rawSearchData = getSearchData(t);
		const searchData = rawSearchData.map((item) => ({
			...item,
			icon: null, // Remove React components for server processing
		}));

		// Initialize embeddings if needed
		await initializeEmbeddings(searchData);

		// Generate query embedding
		const queryEmbedding = await generateEmbedding(query);

		// Check similarity cache first
		const similarityCacheKey = `${query.toLowerCase().trim()}_${documentEmbeddings.length}`;
		const cachedSimilarity = similarityCache.get(similarityCacheKey);

		let similarities: number[];
		if (cachedSimilarity && Date.now() - cachedSimilarity.timestamp < CACHE_DURATION) {
			similarities = cachedSimilarity.similarities;
			console.log("üîç Server: Using cached similarities for query:", query);
		} else {
			// Calculate similarities
			similarities = documentEmbeddings.map((docEmb) => cosineSimilarity(queryEmbedding, docEmb));

			// Cache the similarities
			similarityCache.set(similarityCacheKey, {
				similarities,
				timestamp: Date.now(),
			});

			console.log("üîç Server: Calculated new similarities for query:", query);
		}

		// Map to results with scores and sort
		const results = documents
			.map((doc, i) => ({
				doc,
				score: similarities[i],
			}))
			.filter((result) => result.score > 0.1) // Filter out very low similarity
			.sort((a, b) => b.score - a.score)
			.slice(0, 10) // Limit to 10 results
			.map((result) => result.doc);

		console.log("üîç Server: Semantic search results:", {
			query,
			resultCount: results.length,
			topResults: results.slice(0, 3).map((r: any) => ({ title: r.title, score: similarities[documents.indexOf(r)] })),
		});

		return NextResponse.json({ results });
	} catch (error) {
		console.error("Semantic search API error:", error);
		return NextResponse.json({ error: "Semantic search failed" }, { status: 500 });
	}
}
